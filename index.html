<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Благодійна ініціатива з закупівлі книг</title>
  <meta name="description" content="Ініціатива «єКнига»: спрямовуємо державні 908 грн на книжки для дітей із дитячих будинків" />
  <meta name="theme-color" content="#7423F0" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Шрифт для стабільних цифр на графіку -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-gradient: linear-gradient(135deg, #5B2EFF 0%, #7423F0 100%);
      --bg-blur: 32px;
      --accent: #FFF380;
      --accent-light: #CCF2FF;
      --radius: 16px;
      --shadow: 0 12px 36px -4px rgba(0,0,0,0.35);
      --transition: .35s cubic-bezier(.4,.2,.2,1);
      --text: #FFFFFF;
      --glass-bg: rgba(255,255,255,0.08);
      --glass-bg-hover: rgba(255,255,255,0.14);
      --glass-border: rgba(255,255,255,0.16);
      --focus: #FFF380;
      --step-radius: 20px;
      --safe-bottom: env(safe-area-inset-bottom);
      --mini-nav-h: 54px;

      /* ---- Налаштування нового Canvas-графіка ---- */
      --chart-ar: 720 / 540;         /* вищий графік на мобільних */
      --chart-y-steps: 4;
      --chart-font-scale: .84;       /* зменшені підписи */
      --chart-font-scale-y: var(--chart-font-scale);
      --chart-font-scale-x: calc(var(--chart-font-scale) * .9);
      --chart-min-h: 320px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }

    html, body { overflow-x: hidden; }
    @supports (overflow: clip) { html, body { overflow-x: clip; } }
    img, video, iframe { max-width: 100%; height: auto; }

    html { scroll-behavior: smooth; }
    body{
      margin:0;
      font-family:'Montserrat',system-ui,-apple-system,sans-serif;
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      line-height:1.5;
      min-height:100vh;
      background:#5B2EFF;
      isolation:isolate;
      padding-bottom: calc(var(--mini-nav-h) + max(8px, var(--safe-bottom)));
    }
    body::before{
      content:"";
      position:fixed; inset:-60px; z-index:-1; pointer-events:none;
      background:var(--bg-gradient); filter: blur(var(--bg-blur));
    }
    @supports not ((filter: blur(1px))) { body::before{ inset:0; filter:none; } }

    a{ color:inherit; text-decoration:none; word-break:break-word; }

    /* ===== HERO ===== */
    .hero{ position:relative; padding:clamp(32px,7vw,64px) 16px clamp(22px,5vw,40px); text-align:center; }
    .hero-inner{
      max-width:900px; margin:0 auto;
      background: color-mix(in oklab, white 6%, transparent);
      border:1px solid var(--glass-border); border-radius:28px;
      padding:clamp(24px,7vw,44px) clamp(20px,6vw,48px);
      backdrop-filter:saturate(130%) blur(10px); box-shadow:var(--shadow);
    }
    .hero-eyebrow{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--glass-border);
      background:var(--glass-bg); font-size:.84rem; font-weight:800; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.92);
    }
    .hero h1{
      margin:12px 0 10px; font-size:clamp(1.7rem,5.2vw,2.8rem);
      font-weight:800; letter-spacing:.6px; line-height:1.15;
      background: linear-gradient(92deg, #FFFFFF, var(--accent));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-wrap: balance;
    }
    .hero-subtitle{ margin:6px auto 0; max-width:48ch; font-size:clamp(1rem,3vw,1.16rem); color:rgba(255,255,255,.94); text-wrap: balance; }
    .hero::after,.hero::before{
      content:""; position:absolute; inset:auto; width:420px; height:420px; filter:blur(60px); z-index:-1; opacity:.35; pointer-events:none; border-radius:50%;
    }
    .hero::before{ background: radial-gradient(circle at 30% 30%, #CCF2FF, transparent 60%); left:-120px; top:-80px; }
    .hero::after{ background: radial-gradient(circle at 70% 70%, #FFF380, transparent 60%); right:-120px; bottom:-80px; }

    /* ===== MINI NAV ===== */
    .mini-nav{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:max(10px, var(--safe-bottom)); z-index:50;
      background:rgba(255,255,255,0.10);
      border:1px solid var(--glass-border); border-radius:999px; padding:6px;
      backdrop-filter:saturate(140%) blur(10px); box-shadow:var(--shadow);
      height:var(--mini-nav-h); display:inline-flex; align-items:center; white-space:nowrap;
    }
    .mini-nav ul{ list-style:none; display:flex; gap:6px; padding:0; margin:0; align-items:center; justify-content:center; }
    .mini-nav a{
      position:relative; display:inline-flex; align-items:center; justify-content:center;
      height:40px; padding:0 14px; border-radius:12px; border:1px solid var(--glass-border);
      background:rgba(255,255,255,0.06); font-weight:800; font-size:.95rem; color:rgba(255,255,255,.95);
      letter-spacing:.2px; outline:none; transition: transform .18s ease, background .2s ease, border-color .2s ease;
    }
    .mini-nav a:hover{ transform: translateY(-1px); }
    .mini-nav a:focus-visible{ box-shadow:0 0 0 3px var(--focus); }
    .mini-nav .active{ background:rgba(255,255,255,0.18); border-color:rgba(255,255,255,0.35); }
    @media (min-width:980px){
      body{ padding-bottom:0; }
      .mini-nav{ top:12px; bottom:auto; height:48px; }
      .mini-nav a{ height:36px; }
    }

    /* ===== BASE LAYOUT ===== */
    .container{ max-width:1100px; margin:0 auto; padding:0 14px 68px; }

    .dashboard-title{ font-size:1.95rem; font-weight:800; text-transform:uppercase; letter-spacing:1.5px; text-align:center; color:var(--accent); margin:6px 0 8px; text-shadow:1px 1px 4px rgba(0,0,0,0.3); }
    .dashboard-kicker{ text-align:center; font-size:.74rem; color:rgba(255,255,255,.85); letter-spacing:.12em; text-transform:uppercase; margin-bottom:16px; }

    .stats{ display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; margin-bottom:24px; }
    .card{
      background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius);
      padding:20px 18px; position:relative; overflow:hidden; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; gap:10px;
      min-height:150px; transition: transform var(--transition), background var(--transition), box-shadow var(--transition); box-shadow:var(--shadow);
    }
    .card:hover{ transform:translateY(-4px); background:var(--glass-bg-hover); }
    .card h3{ font-size:1.18rem; font-weight:700; margin:0; color:var(--accent); letter-spacing:.5px; text-transform:uppercase; line-height:1.2; }
    .card .value{ font-size:clamp(2rem,4vw,2.6rem); font-weight:800; color:var(--accent-light); line-height:1.1; display:block; }
    .stat-footnote{ font-size:.78rem; color:rgba(255,255,255,0.82); }
    .card--participants h3{ font-size:1.32rem; }

    .goal-section{ margin-top:8px; display:flex; flex-wrap:wrap; gap:16px; }
    .goal-card{ flex:1 1 100%; background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius); padding:22px 18px; display:flex; flex-direction:column; gap:14px; box-shadow:var(--shadow); }
    .goal-header{ display:flex; flex-wrap:wrap; justify-content:space-between; align-items:baseline; gap:8px; }
    .goal-header h3{ margin:0; font-size:1.12rem; font-weight:800; text-transform:uppercase; color:var(--accent); flex:1; letter-spacing:.5px; }
    .goal-amounts{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .large-number{ font-size:clamp(2rem,5.6vw,2.6rem); font-weight:800; color:#fff; background:rgba(255,255,255,0.08); padding:12px 18px; border-radius:12px; min-width:160px; text-align:center; position:relative; border:1px solid var(--glass-border); }
    .progress-container{ margin-top:2px; }
    .progress-bar-wrapper{ position:relative; height:22px; border-radius:999px; background:rgba(255,255,255,0.08); overflow:hidden; border:1px solid var(--glass-border); }
    .progress-fill{ height:100%; width:0; background: linear-gradient(90deg, #CCF2FF 0%, #FFF380 100%); border-radius:999px; display:flex; align-items:center; justify-content:flex-end; padding-right:8px; font-size:.78rem; font-weight:800; color:#1A1A1A; will-change: width; transition: width .6s ease; }
    .goal-meta{ display:flex; justify-content:space-between; font-size:.9rem; margin-top:6px; flex-wrap:wrap; gap:6px; color:#fff; }
    .overgoaled{ background:rgba(160,255,184,0.15); border-radius:8px; padding:8px 12px; font-size:.9rem; font-weight:700; color:#A0FFB8; display:inline-block; margin-top:6px; align-self:start; border:1px solid rgba(160,255,184,0.35); }
    .last-updated{ font-size:.7rem; color:rgba(255,255,255,0.72); }

    .info-block{ background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius); padding:24px 18px; margin:28px 0; display:flex; flex-direction:column; gap:18px; box-shadow:var(--shadow); }
    .info-block h2{ font-size:clamp(1.4rem,2.2vw,1.7rem); font-weight:800; margin:0; color:var(--accent); text-transform:uppercase; letter-spacing:1px; text-shadow:1px 1px 2px rgba(0,0,0,0.25); }
    .info-block p,.info-block li{ font-size:1rem; color:#fff; }
    .info-block strong{ color:#FFEB99; font-weight:800; }
    .info-block ul{ list-style:disc inside; margin:6px 0 0; }

    .steps{ display:grid; gap:14px; }
    .steps-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .steps-title{ margin:0; font-size:clamp(1.2rem,2vw,1.4rem); font-weight:800; color:var(--accent); text-transform:uppercase; letter-spacing:.6px; }
    .steps-button{ font-size:.9rem; color:rgba(20,20,20,0.95); background:linear-gradient(135deg,#CCF2FF,#FFF380); padding:10px 14px; border-radius:10px; border:1px solid var(--glass-border); display:inline-flex; align-items:center; gap:8px; cursor:pointer; font-weight:800; box-shadow:none; }
    .steps-button:focus-visible{ outline:3px solid var(--focus); outline-offset:2px; }

    .steps-track{
      display:grid; grid-auto-flow:column; grid-auto-columns:minmax(340px,1fr);
      gap:16px; overflow-x:auto; overflow-y:hidden; overscroll-behavior-inline:contain;
      scroll-snap-type:x mandatory; padding:6px 2px 10px; scrollbar-width:thin; -webkit-overflow-scrolling:touch;
    }
    .steps-track::-webkit-scrollbar{ height:8px; }
    .steps-track::-webkit-scrollbar-thumb{ background:rgba(255,255,255,0.25); border-radius:999px; }

    .step{
      scroll-snap-align:start; background:var(--glass-bg); border:1px solid var(--glass-border);
      border-radius:var(--step-radius); padding:24px; display:grid; grid-template-columns:auto 1fr; grid-template-areas:"badge title" "badge text";
      column-gap:16px; row-gap:10px; min-height:260px; backdrop-filter:saturate(120%) blur(8px);
    }
    .step-badge{ grid-area:badge; width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg,#CCF2FF,#FFF380); color:#1A1A1A; display:grid; place-items:center; font-weight:900; font-size:1.15rem; }
    .step-title{ grid-area:title; margin:0; font-weight:800; font-size:1.16rem; color:var(--accent-light); letter-spacing:.3px; align-self:center; }
    .step-text{ grid-area:text; margin:0; font-size:1.06rem; color:#fff; }

    .video-wrapper{ position:relative; width:100%; padding-top:56.25%; border-radius:12px; overflow:hidden; box-shadow:0 12px 36px rgba(0,0,0,0.35); background:#1f1f35; border:1px solid var(--glass-border); }
    .video-wrapper iframe{ position:absolute; inset:0; width:100%; height:100%; border:none; }

    .report{ margin-top:40px; display:flex; flex-direction:column; gap:14px; }
    .report .dashboard-title{ margin-bottom:8px; }
    .report-frame{ position:relative; width:100%; max-width:580px; border-radius:14px; overflow:hidden; box-shadow:var(--shadow); background:var(--glass-bg); margin-inline:auto; border:1px solid var(--glass-border); }
    .report-frame iframe{ width:100%; height:100%; aspect-ratio:500/825; border:none; }
    .report-fallback{ font-size:.9rem; background:rgba(255,255,255,0.06); padding:12px 16px; border-radius:10px; display:inline-block; margin-top:6px; border:1px solid var(--glass-border); }

    .contact{ text-align:center; margin:30px 0 10px; padding:0 10px; }
    .contact p{ margin-bottom:12px; font-size:1rem; line-height:1.4; }
    .contact-button{
      display:inline-block; padding:14px 30px; background:#FFFFFF; color:#7423F0; font-weight:800; border-radius:50px; text-decoration:none;
      box-shadow:0 12px 32px -4px rgba(0,0,0,0.3); transition: transform var(--transition), filter .3s, box-shadow var(--transition);
    }
    .contact-button:hover{ transform:translateY(-2px); filter:brightness(1.05); }
    .contact-button:focus-visible{ outline:3px solid var(--focus); }

    /* ===== FAQ ===== */
    .faq-section h2{ text-align:center; color:var(--accent); margin-top:0; }
    .faq-list{ display:flex; flex-direction:column; gap:10px; }
    .faq-item{ background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:14px; transition:max-height .3s ease-in-out; }
    .faq-item[open] summary{ color:var(--accent); }
    .faq-item summary{ font-weight:800; cursor:pointer; list-style-position:inside; outline:none; }
    .faq-item summary:focus-visible{ outline:3px solid var(--focus); border-radius:8px; outline-offset:3px; }
    .faq-item p{ margin:12px 0 0 0; padding-left:10px; border-left:2px solid var(--accent); font-size:.95rem; color:rgba(255,255,255,0.9); line-height:1.6; }
    .faq-item.closing{ animation: closing-animation .3s ease-out; }
    @keyframes closing-animation{ from{ opacity:1; max-height:300px; } to{ opacity:0; max-height:48px; } }
    summary::marker{ content:'＋ '; color:var(--accent); font-size:1.2em; }
    details[open] summary::marker{ content:'− '; }

    /* ===== ІНФОГРАФІКА — НОВИЙ CANVAS-ГРАФІК ===== */
    .chart-card{
      background:transparent !important;
      border:none !important;
      box-shadow:none !important;
      padding:0 !important;
      font-family:'Inter','Montserrat',system-ui,-apple-system,sans-serif;
    }
    .chart-card h3{ margin:0; font-size:1.02rem; font-weight:800; letter-spacing:.3px; color:var(--accent); text-transform:uppercase; text-align:center; }

    .chart-toolbar{
      display:flex; gap:8px; justify-content:space-between; align-items:center; flex-wrap:wrap;
      margin-bottom:6px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--glass-border); background:rgba(255,255,255,0.06); font-weight:700; font-size:.85rem; color:#fff;
      font-variant-numeric: tabular-nums lining-nums;
    }
    .chip b{ color:var(--accent); }

    .chart-wrap{
      width:100%;
      position:relative;
      aspect-ratio: var(--chart-ar);
      min-height: var(--chart-min-h);
      isolation:isolate;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .chart-wrap canvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
      touch-action: pan-y;
    }
    .chart-tip{
      position:absolute; top:8px; left:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--glass-border);
      background:rgba(255,255,255,0.12); backdrop-filter:saturate(140%) blur(8px); box-shadow:var(--shadow);
      font-size:calc(.86rem * var(--chart-font-scale));
      pointer-events:none; display:none; white-space:nowrap;
      font-variant-numeric: tabular-nums lining-nums;
      font-family:'Inter','Montserrat',system-ui,-apple-system,sans-serif;
    }
    .sr-only{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    @media (min-width:520px){
      :root{
        --chart-ar: 720 / 420;
        --chart-y-steps: 5;
        --chart-font-scale: .9;
        --chart-font-scale-y: var(--chart-font-scale);
        --chart-font-scale-x: calc(var(--chart-font-scale) * .9);
        --chart-min-h: 280px;
      }
      .chip{ font-size:0.82rem; }
      .chart-tip{ font-size:calc(0.82rem * var(--chart-font-scale)); }
    }

    @media (max-width:980px){
      .stats{ grid-template-columns:repeat(2, 1fr); }
      .report{ align-items:center; }
    }
    @media (max-width:520px){
      .hero-inner{ padding:22px 18px; }
      .stats{ grid-template-columns:repeat(2, 1fr); }
      .card{ min-height:170px; padding:22px 16px; }
      .card h3{ font-size:1.22rem; }
      .card--participants h3{ font-size:1.38rem; }
    }

    @media (prefers-reduced-motion: reduce){
      html{ scroll-behavior:auto; }
      .card, .contact-button, .progress-fill{ transition:none !important; }
    }
  </style>
</head>
<body>
  <!-- HERO -->
  <header class="hero" id="top">
    <div class="hero-inner">
      <div class="hero-eyebrow" aria-hidden="true">Благодійна ініціатива</div>
      <h1>Подаруйте книги дітям за «єКнига»</h1>
      <p class="hero-subtitle">Це <strong>не ваші особисті кошти</strong> — держава надає 908 грн. Ми допомагаємо прозоро спрямувати їх на книжки для дитячих будинків.</p>
    </div>
  </header>

  <!-- MINI NAV -->
  <nav class="mini-nav" aria-label="Швидка навігація сайтом">
    <ul role="tablist" aria-label="Навігація сторінкою">
      <li><a href="#stats" data-nav role="tab" aria-controls="stats" aria-selected="true" class="active">Статистика</a></li>
      <li><a href="#guide" data-nav role="tab" aria-controls="guide" aria-selected="false">Інструкція</a></li>
      <li><a href="#faq" data-nav role="tab" aria-controls="faq" aria-selected="false">FAQ</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- Статистика -->
    <section id="stats">
      <div class="dashboard-title">Статистика ініціативи</div>
      <div class="dashboard-kicker" aria-hidden="true">DASHBOARD</div>

      <div class="stats" aria-label="Ключова статистика ініціативи">
        <div class="card" aria-label="Зібрано гривень">
          <h3>Зібрано (₴)</h3>
          <div class="value" id="totalAmount">0</div>
          <div class="stat-footnote">Завдяки благодійникам</div>
        </div>

        <div class="card card--participants" aria-label="Кількість благодійників">
          <h3>Учасників</h3>
          <div class="value" id="donorsCount">0</div>
          <div class="stat-footnote">Людей, які долучилися</div>
        </div>

        <div class="card" aria-label="Дитячі будинки">
          <h3>Дитячих будинків</h3>
          <div class="value" id="orphanagesCount">0</div>
          <div class="stat-footnote">Заклади, які підтримали</div>
        </div>

        <div class="card" aria-label="Одиниці книг / матеріалів">
          <h3>Одиниць книг/матеріалів</h3>
          <div class="value" id="itemsCount">0</div>
          <div class="stat-footnote">Передано</div>
        </div>
      </div>

      <!-- До цілі -->
      <div class="goal-section">
        <div class="goal-card" aria-label="Прогрес до цілі збору коштів">
          <div class="goal-header">
            <h3>До цілі (₴)</h3>
            <div class="last-updated" id="goalUpdated"></div>
          </div>
          <div class="goal-amounts">
            <div class="large-number" aria-label="Залишилось до цілі" id="remaining">0</div>
            <div style="flex:1; min-width:220px;">
              <div class="progress-container">
                <div class="progress-bar-wrapper" aria-hidden="true">
                  <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="goal-meta" aria-live="polite">
                  <div id="percentText">0% зібрано</div>
                  <div id="toGoalText">Залишилось 0 ₴</div>
                </div>
              </div>
            </div>
          </div>
          <div id="overFlowText" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- Інфографіка -->
    <section id="insights" class="info-block" aria-label="Інфографіка ініціативи" data-target="50000">
      <h2>Інфографіка</h2>

      <article class="chart-card" aria-label="Графік зростання зібраної суми за днями">
        <div class="chart-toolbar">
          <div class="left">
            <div class="chip">Період: <b id="periodLabel">—</b></div>
          </div>
        </div>

        <div class="chart-wrap" id="chartWrap">
          <canvas id="growthCanvas" role="img" aria-label="Графік зростання суми від дати до дати" tabindex="0"></canvas>
          <div class="chart-tip" id="chartTip" role="tooltip" aria-hidden="true"></div>
          <div id="chartLive" class="sr-only" aria-live="polite"></div>
        </div>

        <script id="series-data" type="application/json">
          [
            {"date":"2025-07-30","label":"26.07","amount":15000},
            {"date":"2025-07-30","label":"30.07","amount":16603},
            {"date":"2025-07-31","label":"31.07","amount":17525},
            {"date":"2025-08-01","label":"01.08","amount":18535},
            {"date":"2025-08-02","label":"02.08","amount":19485},
            {"date":"2025-08-05","label":"05.08","amount":20452},
            {"date":"2025-08-09","label":"09.08","amount":21952},
            {"date":"2025-08-10","label":"10.08","amount":22352},
            {"date":"2025-08-11","label":"11.08","amount":23387},
            {"date":"2025-08-12","label":"12.08","amount":26334},
            {"date":"2025-08-15","label":"15.08","amount":32155}, 
            {"date":"2025-08-15","label":"16.08","amount":33115}
          ]
        </script>
      </article>
    </section>

    <!-- Контакт -->
    <div class="contact">
      <p>Маєш право на <strong>єКнига (908 грн)</strong> і хочеш передати кошти на книжки для дитячих будинків? Долучайся — без жодних власних витрат.</p>
      <a href="https://t.me/iamhlixli" target="_blank" rel="noopener" class="contact-button" aria-label="Зв'язатися в Telegram">Зв'язатися в Telegram</a>
    </div>

    <!-- Інформація + Інструкція -->
    <section id="guide" class="info-block" aria-label="Інформація про ініціативу та інструкцію">
      <h2>Про ініціативу</h2>
      <p>Ми об’єднуємо благодійників для дітей з дитячих будинків (ДБ) та дитячих будинків сімейного типу (ДБСТ). Якщо тобі <strong>виповнилося 18</strong> і ти маєш право на <strong>«єКнига»</strong>, ти можеш направити <strong>908 грн</strong> на книжки для дітей — швидко та прозоро.</p>

      <div>
        <p><strong>Як це працює?</strong></p>
        <ul>
          <li>Держава надає 908 грн у межах програми «єКнига» — витратити можна лише на книги.</li>
          <li>Після нарахування коштів ти оплачуєш підготовлене замовлення на книжки для конкретного закладу.</li>
          <li>Ми публічно звітуємо про кожну передачу книжок.</li>
        </ul>
      </div>

      <div class="steps" aria-label="Покрокова інструкція">
        <div class="steps-header">
          <h3 class="steps-title">Покрокова інструкція</h3>
          <!-- КНОПКА ГОРТАЙ -->
          <button type="button" id="scrollSteps" class="steps-button" aria-label="Гортай кроки вправо">Гортай →</button>
        </div>

        <div class="steps-track" id="stepsTrack" tabindex="0" role="group" aria-label="Кроки оформлення в застосунку Дія">
          <article class="step" aria-label="Крок 1">
            <div class="step-badge" aria-hidden="true">1</div>
            <h4 class="step-title">Відкрий застосунок Дія</h4>
            <p class="step-text">Перейди в розділ <strong>«Сервіси»</strong> на головному екрані.</p>
          </article>
          <article class="step" aria-label="Крок 2">
            <div class="step-badge" aria-hidden="true">2</div>
            <h4 class="step-title">Обери послугу «єКнига»</h4>
            <p class="step-text">Знайди картку <strong>«єКнига»</strong> у списку сервісів і відкрий її.</p>
          </article>
          <article class="step" aria-label="Крок 3">
            <div class="step-badge" aria-hidden="true">3</div>
            <h4 class="step-title">Ознайомся з умовами</h4>
            <p class="step-text">Натисни <strong>«Розпочати»</strong> та пройди короткі підказки.</p>
          </article>
          <article class="step" aria-label="Крок 4">
            <!-- ВАЖНО: тут была опечатка step-бadge → исправлено на step-badge -->
            <div class="step-badge" aria-hidden="true">4</div>
            <h4 class="step-title">Вибери картку для виплати</h4>
            <p class="step-text">Створи або обери картку, на яку зарахують кошти <strong>єКнига</strong>.</p>
          </article>
          <article class="step" aria-label="Крок 5">
            <div class="step-badge" aria-hidden="true">5</div>
            <h4 class="step-title">Підтверди заяву</h4>
            <p class="step-text">Перевір дані та натисни <strong>«Надіслати»</strong>. Кошти надходять протягом <strong>до 3 днів</strong>.</p>
          </article>
          <article class="step" aria-label="Крок 6">
            <div class="step-badge" aria-hidden="true">6</div>
            <h4 class="step-title">Оплата книжок</h4>
            <p class="step-text">Як тільки кошти надійдуть — я надішлю посилання для оплати підготовленого замовлення.</p>
          </article>
        </div>
      </div>

      <div>
        <p><strong>Відеоінструкція</strong> — усе просто та швидко:</p>
        <div class="video-wrapper" aria-label="Відео інструкція оформлення картки">
          <iframe width="560" height="315" src="https://www.youtube.com/embed/5qc9-pEs_t4?si=xKck3W6izyjK8Py" title="Відеоінструкція: як оформити картку єКнига" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen loading="lazy"></iframe>
        </div>
      </div>

      <p>Після подачі заявки карта з’являється миттєво, а кошти надходять протягом <strong>до 3 днів</strong>. <br><strong>Як тільки кошти надійдуть — я надішлю посилання для оплати книжок.</strong></p>
    </section>

    <!-- Звітування -->
    <section id="reports" class="report">
      <div class="dashboard-title">Звітування</div>
      <div class="report-frame">
        <iframe
          src="https://www.facebook.com/plugins/post.php?href=https%3A%2F%2Fwww.facebook.com%2Fpermalink.php%3Fstory_fbid%3Dpfbid02NhboPBHCDS94mEUDzyBYGcNUEUiK1iMkzaNoaboaFauw82SU5KEyhZ8ia1SDjQJ1l%26id%3D100091519694547&show_text=true"
          loading="lazy"
          title="Facebook звіт">
        </iframe>
      </div>
      <div class="report-fallback">Якщо допис не завантажився — відкрий його у Facebook або онови сторінку.</div>
    </section>
  </div>

  <script>
    /* ---------- CONFIG / FALLBACK DATA ---------- */
    const formatter = new Intl.NumberFormat('uk-UA');
    const fallbackStats = { totalAmount: 33115, donorsCount: 24, orphanagesCount: 6, itemsCount: 114, targetAmount: 50000 };

    /* ---------- SMALL UTILITIES ---------- */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

    function animateCount(id, endValue, duration=800){
      const el = document.getElementById(id); if(!el) return;
      const startV = 0; const start = performance.now();
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const dur = reduce ? 0 : duration;
      function step(now){
        const t = clamp((now - start) / dur, 0, 1);
        const eased = t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t;
        el.textContent = formatter.format(Math.floor(startV + eased * (endValue - startV)));
        if(t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function animateProgress(percent, duration=900){
      const fill = $('#progressFill');
      const percentText = $('#percentText');
      const toGoalText = $('#toGoalText');
      const remainingEl = $('#remaining');
      const overFlowText = $('#overFlowText');
      const goalUpdated = $('#goalUpdated');

      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const dur = reduce ? 0 : duration;
      const start = performance.now();

      function tick(now){
        const t = clamp((now - start)/dur, 0, 1);
        const currentPercent = Math.floor(t * percent);
        if(fill){ fill.style.width = currentPercent + '%'; fill.textContent = `${currentPercent}%`; }
        if(percentText){ percentText.textContent = `${currentPercent}% зібрано`; }
        if(t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);

      const target = Number(($('[data-target]')?.dataset.target) || fallbackStats.targetAmount) || fallbackStats.targetAmount;
      const remaining = Math.max(0, target - currentStats.totalAmount);
      const over = currentStats.totalAmount - target;

      if(currentStats.totalAmount >= target){
        toGoalText.textContent = `Ціль перевиконано`;
        overFlowText.className = 'overgoaled';
        overFlowText.textContent = `Перевиконано на ${formatter.format(over)} ₴`;
        remainingEl.textContent = formatter.format(0);
      }else{
        toGoalText.textContent = `Залишилось ${formatter.format(remaining)} ₴`;
        remainingEl.textContent = formatter.format(remaining);
      }
      if(goalUpdated){
        const d = new Date();
        goalUpdated.textContent = `Оновлено: ${d.toLocaleString('uk-UA', { day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' })}`;
      }
    }

    /* ---------- CSV helpers ---------- */
    function parseCSV(text){
      const firstLine = text.split(/\r?\n/).find(Boolean) || '';
      const delim = (firstLine.match(/;/g)?.length || 0) > (firstLine.match(/,/g)?.length || 0) ? ';' : ',';
      const rows = [];
      let i = 0, field = '', inQuotes = false, row = [];
      while(i < text.length){
        const c = text[i];
        if(c === '"'){
          if(inQuotes && text[i+1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = !inQuotes; i++; continue;
        }
        if(!inQuotes && (c === delim || c === '\n' || c === '\r')){
          row.push(field.trim()); field = '';
          if(c === delim){ i++; continue; }
          if(c === '\r' && text[i+1] === '\n') i++;
          i++;
          if(row.length && row.some(v => v !== '')) rows.push(row);
          row = [];
          continue;
        }
        field += c; i++;
      }
      if(field.length || row.length){ row.push(field.trim()); if(row.some(v => v !== '')) rows.push(row); }
      return rows;
    }

    function normalizeHeader(h){
      const s = h.toLowerCase().trim();
      return s
        .replace(/[їієґ]/g, ch => ({'ї':'i','і':'i','є':'e','ґ':'g'}[ch] || ch))
        .replace(/[^\w]+/g,'');
    }

    function mapColumns(headerRow){
      const map = {};
      headerRow.forEach((h,idx)=>{
        const n = normalizeHeader(h);
        if(/^(date|data|дата)$/.test(n)) map.date = idx;
        if(/^(amount|sum|suma|zibrano|зiбрано|зiбраноуahn|сума|total)$/.test(n)) map.amount = idx;
        if(/^(donors|participants|uchasnyky|учасники|благодiйники)$/.test(n)) map.donors = idx;
        if(/^(items|books|odinici|одиниць|книг)$/.test(n)) map.items = idx;
        if(/^(orphanages|zaklady|заклади|дитячихбудинкiв)$/.test(n)) map.orphanages = idx;
        if(/^(target|meta|цiль|goal)$/.test(n)) map.target = idx;
      });
      return map;
    }

    function buildSeriesFromCSV(rows){
      if(!rows.length) return null;
      const header = rows[0];
      const map = mapColumns(header);
      const body = rows.slice(1).filter(r => r.some(v => v && v.length));
      const byDay = new Map();
      let last = { amount: 0, donors: null, items: null, orphanages: null, target: null, date: null };

      body.forEach(r=>{
        const rawDate = map.date != null ? r[map.date] : null;
        const d = rawDate ? new Date(rawDate) : null;
        if(!d || isNaN(+d)) return;
        const key = d.toISOString().slice(0,10);
        const amount = map.amount != null ? Number(String(r[map.amount]).replace(/[^\d.-]/g,'')) : NaN;
        if(!isNaN(amount)){
          byDay.set(key, { date:key, label: new Date(key).toLocaleDateString('uk-UA',{day:'2-digit',month:'2-digit'}), amount });
          last.amount = amount; last.date = key;
        }
        if(map.donors != null){ const v = Number(String(r[map.donors]).replace(/[^\d.-]/g,'')); if(!isNaN(v)) last.donors = v; }
        if(map.items  != null){ const v = Number(String(r[map.items]).replace(/[^\d.-]/g,'')); if(!isNaN(v)) last.items = v; }
        if(map.orphanages != null){ const v = Number(String(r[map.orphanages]).replace(/[^\d.-]/g,'')); if(!isNaN(v)) last.orphanages = v; }
        if(map.target != null){ const v = Number(String(r[map.target]).replace(/[^\d.-]/g,'')); if(!isNaN(v)) last.target = v; }
      });

      const series = Array.from(byDay.values()).sort((a,b)=> a.date.localeCompare(b.date));
      return { series, last };
    }

    /* =========================
       НОВИЙ CANVAS-ГРАФІК
       ========================= */
    let currentSeries = [];
    let currentStats  = {...fallbackStats};
    let highlightIndex = null;
    let canvas, ctx, wrap, dpr = Math.max(1, window.devicePixelRatio || 1);

    function niceNumber(range, round){
      const exponent = Math.floor(Math.log10(Math.max(1, range)));
      const fraction = range / Math.pow(10, exponent);
      let niceFraction;
      if(round){
        if(fraction < 1.5) niceFraction = 1;
        else if(fraction < 3) niceFraction = 2;
        else if(fraction < 7) niceFraction = 5;
        else niceFraction = 10;
      }else{
        if(fraction <= 1) niceFraction = 1;
        else if(fraction <= 2) niceFraction = 2;
        else if(fraction <= 5) niceFraction = 5;
        else niceFraction = 10;
      }
      return niceFraction * Math.pow(10, exponent);
    }
    function niceScale(min, max, maxTicks=5){
      const range = niceNumber(max - min, false);
      const step = niceNumber(range / Math.max(1, (maxTicks-1)), true);
      const niceMin = Math.floor(min / step) * step;
      const niceMax = Math.ceil(max / step) * step;
      return { niceMin, niceMax, step };
    }

    function initCanvas(){
      wrap = document.getElementById('chartWrap');
      canvas = document.getElementById('growthCanvas');
      if(!wrap || !canvas) return false;
      ctx = canvas.getContext('2d');
      resizeCanvas();
      return true;
    }

    function resizeCanvas(){
      const rect = wrap.getBoundingClientRect();
      const cssW = Math.max(10, rect.width);
      const cssH = Math.max(10, rect.height);
      dpr = Math.max(1, window.devicePixelRatio || 1);

      canvas.width  = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
      canvas.style.width  = cssW + 'px';
      canvas.style.height = cssH + 'px';

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
    }

    function drawSmoothLine(points){
      if(points.length < 2) return;
      ctx.beginPath();
      ctx.moveTo(points[0][0], points[0][1]);
      for(let i=0; i<points.length-1; i++){
        const p0 = points[i-1] || points[i];
        const p1 = points[i];
        const p2 = points[i+1];
        const p3 = points[i+2] || p2;
        const cp1x = p1[0] + (p2[0]-p0[0]) / 6;
        const cp1y = p1[1] + (p2[1]-p0[1]) / 6;
        const cp2x = p2[0] - (p3[0]-p1[0]) / 6;
        const cp2y = p2[1] - (p3[1]-p1[1]) / 6;
        ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2[0], p2[1]);
      }
    }

    function drawCanvasChart(animT = 1){
      if(!ctx || !currentSeries.length) return;

      const isNarrow = wrap.clientWidth < 520;
      const isTiny   = wrap.clientWidth < 380;
      const pad = isTiny
        ? { l: 14, r: 18, t: 10, b: 46 }
        : isNarrow
          ? { l: 16, r: 20, t: 12, b: 48 }
          : { l: 48, r: 24, t: 16, b: 52 };

      const W = canvas.clientWidth;
      const H = canvas.clientHeight;
      const pw = W - pad.l - pad.r;
      const ph = H - pad.t - pad.b;

      ctx.clearRect(0, 0, W, H);

      const targetAmount = currentStats.targetAmount || fallbackStats.targetAmount;
      const maxData = Math.max(...currentSeries.map(s => s.amount));
      const maxForScale = Math.max(targetAmount, maxData);
      const stepsYcss = Number(getComputedStyle(document.documentElement).getPropertyValue('--chart-y-steps')) || 5;
      const { niceMin, niceMax, step } = niceScale(0, maxForScale, stepsYcss+1);

      const y = v => pad.t + (1 - ((v - niceMin)/(niceMax - niceMin || 1))) * ph;
      const x = i => pad.l + (currentSeries.length === 1 ? pw/2 : (i * (pw / (currentSeries.length - 1))));

      const pts = currentSeries.map((s,i)=> [x(i), y(s.amount)]);

      /* ---------- Сітка ---------- */
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.10)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      for(let val = niceMin; val <= niceMax + 0.5*step; val += step){
        const yy = y(val);
        ctx.moveTo(pad.l, yy);
        ctx.lineTo(pad.l+pw, yy);
      }
      ctx.stroke();
      ctx.restore();

      /* ---------- Підписи Y ---------- */
      const rootStyles = getComputedStyle(document.documentElement);
      const scale = parseFloat(rootStyles.getPropertyValue('--chart-font-scale')) || 1;
      const scaleY = parseFloat(rootStyles.getPropertyValue('--chart-font-scale-y')) || scale;
      const scaleX = parseFloat(rootStyles.getPropertyValue('--chart-font-scale-x')) || scale;

      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.72)';
      ctx.font = `700 ${Math.max(10, 12 * scaleY)}px Inter, Montserrat, system-ui, -apple-system, sans-serif`;
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      for(let val = niceMin; val <= niceMax + 0.5*step; val += step){
        const yy = y(val);
        ctx.fillText(formatter.format(Math.max(0, Math.round(val))), pad.l + 2, yy);
      }
      ctx.restore();

      /* ---------- Область під кривою ---------- */
      const revealCount = Math.max(2, Math.round((pts.length) * animT));
      const visiblePts = pts.slice(0, revealCount);

      const gradFill = ctx.createLinearGradient(0, pad.t, 0, pad.t + ph);
      gradFill.addColorStop(0, 'rgba(255,243,128,0.36)');
      gradFill.addColorStop(1, 'rgba(255,243,128,0)');

      if(visiblePts.length >= 2){
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(pad.l, y(niceMin));
        drawSmoothLine(visiblePts);
        ctx.lineTo(pad.l + (visiblePts[visiblePts.length-1][0] - pad.l), y(niceMin));
        ctx.closePath();
        ctx.fillStyle = gradFill;
        ctx.fill();
        ctx.restore();
      }

      /* ---------- Лінія ---------- */
      const gradStroke = ctx.createLinearGradient(pad.l, 0, pad.l+pw, 0);
      gradStroke.addColorStop(0, '#CCF2FF');
      gradStroke.addColorStop(1, '#FFF380');

      ctx.save();
      ctx.lineWidth = 3;
      ctx.strokeStyle = gradStroke;
      ctx.shadowColor = 'rgba(0,0,0,0.2)';
      ctx.shadowBlur = 3;
      ctx.beginPath();
      drawSmoothLine(visiblePts);
      ctx.stroke();
      ctx.restore();

      /* ---------- Лінія цілі + підпис ---------- */
      if(targetAmount >= niceMin && targetAmount <= niceMax){
        const ty = y(targetAmount);
        ctx.save();
        ctx.setLineDash([6,6]);
        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
        ctx.beginPath();
        ctx.moveTo(pad.l, ty);
        ctx.lineTo(pad.l+pw, ty);
        ctx.stroke();
        ctx.setLineDash([]);

        ctx.fillStyle = 'rgba(255,255,255,0.96)';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'top';
        const labelY = Math.min(pad.t + ph - 10, ty + 10);
        ctx.font = `700 ${Math.max(10, 12 * scaleY)}px Inter, Montserrat, system-ui, -apple-system, sans-serif`;
        ctx.fillText(`Ціль: ${formatter.format(targetAmount)} ₴`, pad.l+pw-6, labelY);
        ctx.restore();
      }

      /* ---------- Підписи X (дати) ---------- */
      const desiredLabels = clamp(Math.round(wrap.clientWidth / 90), 4, 12);
      const labelEvery = Math.max(1, Math.ceil(currentSeries.length / desiredLabels));
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.96)';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.font = `700 ${Math.max(9, 12 * scaleX)}px Inter, Montserrat, system-ui, -apple-system, sans-serif`;
      for(let i=0;i<currentSeries.length;i++){
        if(i===0 || i===currentSeries.length-1 || i % labelEvery === 0){
          ctx.fillText(currentSeries[i].label, x(i), pad.t + ph + 18);
        }
      }
      ctx.restore();

      /* ---------- Ховер/кросхейр ---------- */
      const tip = $('#chartTip');
      if(highlightIndex != null){
        const hx = x(highlightIndex);
        const hy = y(currentSeries[highlightIndex].amount);

        ctx.save();
        ctx.strokeStyle = 'rgba(255,255,255,0.20)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(hx, pad.t);
        ctx.lineTo(hx, pad.t + ph);
        ctx.stroke();
        ctx.restore();

        ctx.save();
        ctx.fillStyle = '#FFF380';
        ctx.beginPath();
        ctx.arc(hx, hy, isNarrow ? 5.2 : 4.2, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        const s = currentSeries[highlightIndex];
        const prev = highlightIndex>0 ? currentSeries[highlightIndex-1].amount : null;
        const delta = prev!=null ? s.amount - prev : null;
        if(tip){
          tip.style.display = 'block';
          tip.setAttribute('aria-hidden','false');
          tip.innerHTML = `<strong>${s.label}</strong> — ${formatter.format(s.amount)} ₴${delta!=null ? ` <span style="opacity:.9;">(＋${formatter.format(delta)})</span>` : ''}`;

          const wrapRect = wrap.getBoundingClientRect();
          const tipBoxWidth = tip.getBoundingClientRect().width || 160;
          const insideX = clamp(hx + 12, 8, wrapRect.width - tipBoxWidth - 8);
          tip.style.transform = `translate(${insideX}px, 8px)`;
        }
      }else{
        if(tip){
          tip.style.display = 'none';
          tip.setAttribute('aria-hidden','true');
        }
      }

      const live = $('#chartLive');
      if(live && currentSeries.length){
        const last = currentSeries[currentSeries.length-1];
        const prev = currentSeries.length>1 ? currentSeries[currentSeries.length-2] : null;
        const delta = prev ? last.amount - prev.amount : 0;
        live.textContent = `Станом на ${last.label}: ${formatter.format(last.amount)} гривень${prev ? ` (за день +${formatter.format(delta)})` : ''}`;
      }

      const periodLabel = $('#periodLabel');
      if(periodLabel && currentSeries.length){
        const s = new Date(currentSeries[0].date).toLocaleDateString('uk-UA');
        const e = new Date(currentSeries[currentSeries.length-1].date).toLocaleDateString('uk-UA');
        periodLabel.textContent = `${s} — ${e}`;
      }
    }

    function animateChart(){
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(reduce){ drawCanvasChart(1); return; }
      const t0 = performance.now();
      const dur = 1000;
      function tick(now){
        const t = clamp((now - t0)/dur, 0, 1);
        drawCanvasChart(t);
        if(t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function nearestIndexFromClient(clientX){
      const rect = wrap.getBoundingClientRect();
      const xRel = clamp(clientX - rect.left, 0, rect.width);
      const count = currentSeries.length;
      if(count <= 1) return 0;
      const idx = Math.round((xRel / rect.width) * (count - 1));
      return clamp(idx, 0, count-1);
    }

    function attachInteractions(){
      if(!canvas) return;
      const onMove = (e)=>{
        const p = e.touches ? e.touches[0] : e;
        if(!p) return;
        highlightIndex = nearestIndexFromClient(p.clientX);
        drawCanvasChart(1);
      };
      const onLeave = ()=>{
        highlightIndex = null;
        drawCanvasChart(1);
      };
      canvas.addEventListener('mousemove', onMove, {passive:true});
      canvas.addEventListener('mouseleave', onLeave, {passive:true});
      canvas.addEventListener('touchstart', onMove, {passive:true});
      canvas.addEventListener('touchmove', onMove, {passive:true});
      canvas.addEventListener('touchend', onLeave, {passive:true});
      canvas.addEventListener('touchcancel', onLeave, {passive:true});

      canvas.addEventListener('keydown', (e)=>{
        if(!currentSeries.length) return;
        if(highlightIndex == null) highlightIndex = currentSeries.length-1;
        if(e.key === 'ArrowLeft'){ highlightIndex = clamp(highlightIndex-1, 0, currentSeries.length-1); drawCanvasChart(1); e.preventDefault(); }
        if(e.key === 'ArrowRight'){ highlightIndex = clamp(highlightIndex+1, 0, currentSeries.length-1); drawCanvasChart(1); e.preventDefault(); }
      });
    }

    /* ---------- NEW: Scroll button for steps ---------- */
    function setupStepsScrollButton(){
      const btn = document.getElementById('scrollSteps');
      const track = document.getElementById('stepsTrack');
      if(!btn || !track) return;

      const updateVisibility = () => {
        const overflow = track.scrollWidth - track.clientWidth > 6;
        btn.style.display = overflow ? 'inline-flex' : 'none';
      };

      btn.addEventListener('click', ()=>{
        const step = Math.max(track.clientWidth * 0.9, 320);
        const maxLeft = track.scrollWidth - track.clientWidth;
        const next = Math.min(track.scrollLeft + step, maxLeft);
        track.scrollTo({ left: next, behavior: 'smooth' });

        // якщо дійшли до кінця — повертаємось на початок для циклу
        if(next >= maxLeft - 2){
          setTimeout(()=> track.scrollTo({ left: 0, behavior: 'smooth' }), 600);
        }
      });

      // Підтримка клавіатури на самій доріжці
      track.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowRight'){
          btn.click(); e.preventDefault();
        }
        if(e.key === 'ArrowLeft'){
          const step = Math.max(track.clientWidth * 0.9, 320);
          track.scrollBy({ left: -step, behavior: 'smooth' });
          e.preventDefault();
        }
      });

      window.addEventListener('resize', updateVisibility);
      // Початковий стан
      updateVisibility();
    }

    /* ---------- INIT & DATA FLOW ---------- */
    function initStaticSeries(){
      try{
        const raw = document.getElementById('series-data').textContent.trim();
        const series = JSON.parse(raw);
        currentSeries = series;
        currentStats.totalAmount = series[series.length-1]?.amount ?? fallbackStats.totalAmount;
      }catch(e){
        console.warn('Fallback JSON series missing/invalid', e);
        currentSeries = [];
        currentStats.totalAmount = fallbackStats.totalAmount;
      }
      const sec = document.getElementById('insights');
      if(sec && sec.dataset.target) currentStats.targetAmount = Number(sec.dataset.target) || fallbackStats.targetAmount;
      currentStats.donorsCount = fallbackStats.donorsCount;
      currentStats.itemsCount = fallbackStats.itemsCount;
      currentStats.orphanagesCount = fallbackStats.orphanagesCount;
    }

    function handleCSVFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const rows = parseCSV(reader.result);
          const res = buildSeriesFromCSV(rows);
          if(!res || !res.series.length) throw new Error('CSV не містить придатних даних');
          currentSeries = res.series;
          if(res.last.amount != null) currentStats.totalAmount = res.last.amount;
          if(res.last.donors != null) currentStats.donorsCount = res.last.donors;
          if(res.last.items != null) currentStats.itemsCount = res.last.items;
          if(res.last.orphanages != null) currentStats.orphanagesCount = res.last.orphanages;
          if(res.last.target != null) currentStats.targetAmount = res.last.target;

          refreshStatsFromSeries();
          resizeCanvas();
          animateChart();
        }catch(err){
          alert('Помилка читання CSV: ' + err.message);
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    function refreshStatsFromSeries(){
      animateCount('totalAmount', currentStats.totalAmount, 900);
      animateCount('donorsCount', currentStats.donorsCount ?? 0, 700);
      animateCount('orphanagesCount', currentStats.orphanagesCount ?? 0, 700);
      animateCount('itemsCount', currentStats.itemsCount ?? 0, 700);

      const coverage = Math.min(100, Math.round((currentStats.totalAmount / (currentStats.targetAmount||fallbackStats.targetAmount)) * 100));
      animateProgress(coverage, 900);
    }

    function lazyRenderChart(){
      if(!('IntersectionObserver' in window) || !wrap){
        animateChart(); return;
      }
      let drawn = false;
      const obs = new IntersectionObserver((entries)=>{
        const en = entries[0];
        if(en && en.isIntersecting && !drawn){
          drawn = true;
          animateChart();
          obs.disconnect();
        }
      }, { root: null, rootMargin: '0px 0px -20% 0px', threshold: 0.15 });
      obs.observe(wrap);
    }

    let resizeTO;
    function attachResizers(){
      window.addEventListener('resize', ()=>{
        clearTimeout(resizeTO);
        resizeTO = setTimeout(()=>{
          resizeCanvas();
          drawCanvasChart(1);
        }, 120);
      });
      if('ResizeObserver' in window){
        const ro = new ResizeObserver(()=>{
          clearTimeout(resizeTO);
          resizeTO = setTimeout(()=>{
            resizeCanvas();
            drawCanvasChart(1);
          }, 80);
        });
        ro.observe(wrap);
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      initStaticSeries();
      refreshStatsFromSeries();

      // steps scroll button init
      setupStepsScrollButton();

      if(initCanvas()){
        attachResizers();
        attachInteractions();
        lazyRenderChart();
      }
    });
  </script>
</body>
</html>
